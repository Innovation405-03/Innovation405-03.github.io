<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NCF - Analysis</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="navbar">
        <h2>NCF Menu</h2>
        <ul>
            <li><a href="index.html">Home</a></li>
            <li><a href="analysis.html">Analysis</a></li>
            <li><a href="reports.html">Reports</a></li>
            <li><a href="about.html">About</a></li>
        </ul>
    </div>
    <div class="content centered-content">
        <div class="card">
            <center><h2>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏™‡∏µ</h2></center>
        </div>
        <div class="card">
            <div>
                <center>
                    <input class="analysis" type="file" id="fileInput" accept="image/*">
                    <button id="captureFromCamera" style="border-color:#fff; font-family:Kanit-light;">üì∑ Capture from Camera</button>
                </center>
                <br>
                <center>
                    <button id="analyzeData" style="background-color: #333; color:#fff; font-weight:bold;">üîç Analyze</button>
                </center>
            </div>
        </div>
        <video id="video" width="320" height="240" autoplay style="display:none;"></video>
        <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
        <div id="colorBox"></div>
        <div class="card">
            <p id="colorValue">Color: N/A</p>
            <p id="nitrateValue">Nitrate Level: N/A</p>
            <br>
            <center>
                <button id="saveData" style="background-color: #333; color:#fff; font-weight:bold;">üíæ Save Data</button>
            </center>
        </div>
    </div>
    <div class="footer">
        &copy; <span id="currentYear"></span>
        <span>Innovation 405-03.</span>
        <text>Princess Chulabhorn Science High School Nakhon Si Thammarat</text>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            document.getElementById('currentYear').textContent = new Date().getFullYear();

            const fileInput = document.getElementById('fileInput');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            const colorBox = document.getElementById('colorBox');
            const colorValue = document.getElementById('colorValue');
            const nitrateValue = document.getElementById('nitrateValue');
            const analyzeData = document.getElementById('analyzeData');
            const saveData = document.getElementById('saveData');
            const captureButton = document.getElementById('captureFromCamera');

            // Load Pyodide
            let pyodide = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/" });
            await pyodide.loadPackage(['numpy']);

            fileInput.addEventListener('change', (event) => {
                handleFile(event.target.files[0]);
            });

            async function handleFile(file) {
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        context.drawImage(img, 0, 0, img.width, img.height);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }

            analyzeData.addEventListener('click', async () => {
                if (!canvas.width || !canvas.height) {
                    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πà‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå!");
                    return;
                }

                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                try {
                    const result = await analyzeImage(imageData);
                    const color = result.mean_color;
                    const nitrateLevel = result.nitrate_level;

                    colorBox.style.backgroundColor = color;
                    colorValue.textContent = `Color: ${color}`;
                    nitrateValue.textContent = `Nitrate Level: ${nitrateLevel}`;
                } catch (error) {
                    console.error("Error analyzing image:", error);
                }
            });

            async function analyzeImage(imageData) {
                const imageArray = Array.from(imageData.data);

                const pythonCode = `
import numpy as np
import json

def rgb_to_hex(rgb):
    return '#{:02x}{:02x}{:02x}'.format(int(rgb[0]), int(rgb[1]), int(rgb[2]))

def analyze_nitrate(imageData):
    data = np.array(imageData).reshape(-1, 4)[:, :3]
    mean_color = np.mean(data, axis=0)

    orange_color = np.array([255, 165, 0])  # High Nitrate
    purple_color = np.array([138, 43, 226])  # Normal Nitrate

    color_diff_to_orange = np.linalg.norm(mean_color - orange_color)
    color_diff_to_purple = np.linalg.norm(mean_color - purple_color)

    nitrate_level = 'High' if color_diff_to_orange < color_diff_to_purple else 'Normal'

    return json.dumps({
        'mean_color': rgb_to_hex(mean_color),
        'nitrate_level': nitrate_level
    })

result = analyze_nitrate(imageData)
result
`;

                const result = await pyodide.runPythonAsync(pythonCode, { imageData: imageArray });
                return JSON.parse(result);
            }

            saveData.addEventListener('click', () => {
                const color = colorValue.textContent.split(": ")[1];
                const nitrateLevel = nitrateValue.textContent.split(": ")[1];

                if (color === "N/A" || nitrateLevel === "N/A") {
                    alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å!");
                    return;
                }

                const results = JSON.parse(localStorage.getItem('nitrateResults')) || [];
                const timestamp = new Date().toISOString();
                results.push({ color, nitrateLevel, timestamp });
                localStorage.setItem('nitrateResults', JSON.stringify(results));

                alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
            });

            captureButton.addEventListener('click', async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    const video = document.getElementById('video');
                    video.srcObject = stream;
                    video.play();

                    setTimeout(() => {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        context.drawImage(video, 0, 0, canvas.width, canvas.height);
                        stream.getTracks().forEach(track => track.stop());
                    }, 2000);
                } catch (error) {
                    console.error("Error accessing camera:", error);
                }
            });
        });
    </script>
</body>
</html>